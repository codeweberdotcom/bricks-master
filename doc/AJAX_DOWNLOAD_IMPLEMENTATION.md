# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è AJAX –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. REST API Endpoint
**–§–∞–π–ª:** `wp-content/themes/codeweber/functions/cpt/cpt-documents.php`

–î–æ–±–∞–≤–ª–µ–Ω endpoint: `/codeweber/v1/documents/{id}/download-url`

- –ü–æ–ª—É—á–∞–µ—Ç ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL —Ñ–∞–π–ª–∞, –∏–º—è —Ñ–∞–π–ª–∞ –∏ ID –ø–æ—Å—Ç–∞
- –õ–æ–≥–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ —Ö—É–∫ `document_downloaded`

### 2. JavaScript –¥–ª—è AJAX –∑–∞–≥—Ä—É–∑–∫–∏
**–§–∞–π–ª:** `wp-content/themes/codeweber/src/assets/js/ajax-download.js`

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º —Å –∫–ª–∞—Å—Å–æ–º `.ajax-download`
- –ü–æ–ª—É—á–∞–µ—Ç URL —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ REST API
- –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Google Analytics (–µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω)

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
**–§–∞–π–ª:** `wp-content/themes/codeweber/templates/post-cards/documents/card.php`

–ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–ø–µ—Ä—å:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª–∞—Å—Å `.ajax-download`
- –ò–º–µ–µ—Ç –∞—Ç—Ä–∏–±—É—Ç—ã `data-post-id` –∏ `data-file-name`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ

### 4. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
**–§–∞–π–ª:** `wp-content/themes/codeweber/functions/enqueues.php`

–°–∫—Ä–∏–ø—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞:
- –ê—Ä—Ö–∏–≤–∞—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –û—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –°—Ç—Ä–∞–Ω–∏—Ü–∞—Ö —Å –±–ª–æ–∫–∞–º–∏ post-grid
- –í—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –∏ –∞—Ä—Ö–∏–≤–∞—Ö (–¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏)

## üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í —à–∞–±–ª–æ–Ω–∞—Ö

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AJAX –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É —Å –∫–ª–∞—Å—Å–æ–º `.ajax-download`:

```php
<a href="javascript:void(0)" 
   class="btn btn-primary ajax-download<?php echo getThemeButton(); ?>"
   data-post-id="<?php echo esc_attr($post_id); ?>"
   data-file-name="<?php echo esc_attr($file_name); ?>"
   data-loading-text="<?php esc_attr_e('Loading...', 'codeweber'); ?>">
    <i class="uil uil-import"></i>
    <span><?php esc_html_e('Download', 'codeweber'); ?></span>
</a>
```

### –ê—Ç—Ä–∏–±—É—Ç—ã –∫–Ω–æ–ø–∫–∏

- `data-post-id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) - ID –ø–æ—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- `data-file-name` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
- `data-loading-text` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –¢–µ–∫—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "Loading...")
- `class="ajax-download"` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) - –ö–ª–∞—Å—Å –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```javascript
// –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
if (typeof window.ajaxDownloadFile !== 'undefined') {
    window.ajaxDownloadFile(
        postId,        // ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
        fileName,      // –ò–º—è —Ñ–∞–π–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        buttonElement, // –≠–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        onSuccess,     // Callback –ø—Ä–∏ —É—Å–ø–µ—Ö–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        onError        // Callback –ø—Ä–∏ –æ—à–∏–±–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    );
}
```

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–æ–∫

–î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–æ–∫ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ö—É–∫ `document_downloaded`:

```php
add_action('document_downloaded', function($post_id) {
    $downloads = get_post_meta($post_id, '_document_downloads', true);
    $downloads = $downloads ? intval($downloads) + 1 : 1;
    update_post_meta($post_id, '_document_downloads', $downloads);
});
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞

–î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑–º–µ–Ω–∏—Ç–µ `permission_callback` –≤ endpoint:

```php
'permission_callback' => function() {
    return is_user_logged_in(); // –¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
}
```

## üöÄ –°–±–æ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ `src/assets/js/ajax-download.js` –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
npm run build
```

–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é –≤ `dist/assets/js/ajax-download.js`

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. ‚úÖ **–ë–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã** - –ª—É—á—à–∏–π UX
2. ‚úÖ **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
3. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
4. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —É—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–≥—Ä—É–∑–æ–∫
5. ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –∏ —Ç.–¥.

## üîç –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `wpApiSettings` –¥–æ—Å—Ç—É–ø–µ–Ω (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω `restapi.js`)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ REST API endpoint –¥–æ—Å—Ç—É–ø–µ–Ω: `/wp-json/codeweber/v1/documents/{id}/download-url`
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –µ—Å—Ç—å —Ñ–∞–π–ª –≤ –º–µ—Ç–∞–ø–æ–ª–µ `_document_file`

